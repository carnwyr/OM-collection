extends layout

block scripts
  link(rel="stylesheet" href="/stylesheets/cardDetail.css")
  script.
    var i18next = { "collected_count": "#{t("cards.collected_count", { percentage: "undefined" })}", "favourite_count": "!{t("cards.favourite_count", { percentage: "undefined" })}" };
    const CARD_NAME = !{JSON.stringify(card.uniqueName)};
  if user && !isHidden
    script(src="/javascripts/cardDetailFunctions.js")
    script.
      var stats = !{JSON.stringify(stats)};
  else
    script.
      $(function() {
        $(".owned, .favourites").on("click", () => {
          showAlert("warning", "Please log in!");
        });
      });

mixin dtTemplate(node)
  div.col-12.col-md-4.mb-3
    div(class="p-3 dt-node " + node.type)
      div.d-flex.flex-wrap.align-items-center
        img.mb-2.mb-md-0(src="/images/nodes/" + node.type + ".png" alt=node.type style="width:32px;height:32px;")
        span.text-center.w-100= node.reward
      hr
      if node.requirements.length !== 0
        ul
          each i in node.requirements
            li= i.name && i.amount ? i.name + ' x' + i.amount : "???"
      else
        p.text-center ???
      p.text-center Grimm: #{node.grimmCost ? node.grimmCost.toLocaleString("en") : "???"}
      hr
      div.form-check.text-center
        input.form-check-input(id=`${node.reward}_${node.nodeOrder}_completion` type="checkbox" disabled)
        label.form-check-label(for=`${node.reward}_${node.nodeOrder}_completion`) Unlocked

block content
  div#alert(role="alert")
  div.container
    h1= title
    if user && !isHidden
      div.d-flex.align-items-center.mb-3.d-md-none
        button.btn.btn-primary.mr-2.owned(type="button") collection
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" stroke="black" class="bi bi-star-fill favourites" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.283.95l-3.523 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>
    div.card-container.my-4.my-md-3
      if card.type === "Demon"
        div.w-50.pr-1.pr-md-0
          h5.d-none.d-md-block Devil's Flower locked
          a(href="/images/cards/L/" + card.uniqueName + ".jpg")
            img.img-fluid.shadow(src="/images/cards/L/" + card.uniqueName + ".jpg")
        div.w-50.pl-1.pr-md-0
          h5.d-none.d-md-block Unlocked
          a(href="/images/cards/L/" + card.uniqueName + "_b.jpg")
            img.img-fluid.shadow(src="/images/cards/L/" + card.uniqueName + "_b.jpg")
      else
        div#memory
          a(href="/images/cards/L/" + card.uniqueName + ".jpg")
            img.img-fluid.shadow(src="/images/cards/L/" + card.uniqueName + ".jpg")

    div#info.card.mb-3(style="border-left:3px solid var(--primary);")
      div.card-body
        div.card-title.d-flex.justify-content-between
          h5.m-0 Card Stats
          if !isHidden
            div: a.btn.btn-outline-primary.px-3(role="button" href=card.uniqueName+"/edit")
              | <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square mb-1" viewBox="0 0 16 16">   <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>   <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/> </svg>
              | Edit
        div.container
          div.row
            div.col-12.col-md-2
              span= t("cards.type")
            div.col-12.col-md-4
              span= t("cards."+card.type)
            div.col-12.col-md-2
              span= t("cards.rarity")
            div.col-12.col-md-4
              a(href="/cards?rarity="+encodeURIComponent(card.rarity))= card.rarity
            div.col-12.col-md-2
              span= t("cards.attribute")
            div.col-12.col-md-4
              a(href="/cards?attribute="+card.attribute)= t(card.attribute)
            div.col-12.col-md-2
              span= card.characters.length>1?t("cards.characters"):t("cards.character")
            div.col-12.col-md-4
              each val, index in card.characters
                a(href="/cards?character="+(val==="Little D"?"LittleD":val))= t(val)
                if index < card.characters.length - 1
                  | ,
                  |
            div.col-12.col-md-2
              span= t("cards.source")
            div.col-12.col-md-auto
              each val, index in card.source
                a(href="/event/"+card.source_link[index])= val
                if index < card.source.length - 1
                  | ,
                  |
        hr
        if !isHidden
          p.text-center.ownedCount= t("cards.collected_count", { percentage: stats.ownedTotal })
          p.text-center.favedCount!= t("cards.favourite_count", { percentage: stats.favedTotal })
          hr
          div.d-flex.align-items-center
            button.btn.btn-primary.mr-2.owned(type="button")= user?"collection":"Add to collection"
            <svg id="star" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" stroke="black" class="bi bi-star-fill favourites" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.283.95l-3.523 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>
        if user && user.isAdmin
          if isHidden
            div.mt-2: a.btn.btn-primary(role="button" href=card.uniqueName+"/makePublic") Make public
          div.mt-2: button.btn.btn-primary(data-toggle='modal' data-target="#confirmDelete") Delete card

    div.card.mb-3(style="border-left:3px solid #d289fb;")
      div.card-body
        h5.card-title.d-flex.flex-wrap.justify-content-between.align-items-center Attribute values
          a.btn.btn-link(data-toggle="collapse" href="#collapseStrength" role="button" aria-expanded="true" aria-controls="collapseStrength") (collapse)
        div#collapseStrength.collapse.show
          div.table-responsive
            table#strength.table
              thead
                tr
                  th(scope="col")
                  th(scope="col")
                    abbr(title="Base value") Min
                  th(scope="col")
                    abbr(title="Maximum level reached without unlocking max cap and devil's tree unlocked up to and including the flower.") Max
                  th(scope="col")
                    abbr(title="Maximum level reached without unlocking max cap and devil's tree at 100%") FDT
              tbody
                - let attributeList = ["pride", "greed", "envy", "wrath", "lust", "gluttony", "sloth"];
                each attribute in attributeList
                  tr
                    - let str = attribute.charAt(0).toUpperCase() + attribute.slice(1);
                    th.text-center.text-md-left(scope="row")
                      img.mr-0.mr-md-2(src="/images/attributes/" + t(attribute) + ".png" alt=str style="width:24px;height:24px;")
                      span.d-none.d-md-block= t(str)
                    td= card.strength&&card.strength[attribute]&&card.strength[attribute].min?card.strength[attribute].min.toLocaleString("en"):"???"
                    td= card.strength&&card.strength[attribute]&&card.strength[attribute].max?card.strength[attribute].max.toLocaleString("en"):"???"
                    td= card.strength&&card.strength[attribute]&&card.strength[attribute].fdt?card.strength[attribute].fdt.toLocaleString("en"):"???"
                tr
                  th.text-center.text-md-left(scope="row") Total
                  td= getTotalStrength("min")
                  td= getTotalStrength("max")
                  td= getTotalStrength("fdt")
    div.card.mb-3(style="border-left:3px solid #d289fb;")
      div.card-body
        h5.card-title.d-flex.flex-wrap.justify-content-between.align-items-center Devil's tree
          a.btn.btn-link(data-toggle="collapse" href="#collapseTree" role="button" aria-expanded="true" aria-controls="collapseTree") (collapse)
        div#collapseTree.collapse.show
          div.text-center
            p Devil's tree tracker will be ready when there's more data. Help us add missing data so the tracker can be ready sooner.
            a(href=card.uniqueName+"/edit") Click here to edit data.
            hr
          if card.dt
            p.section-title Rewards
            div.row.justify-content-center
              - let rewards = card.dt.filter(x => x.type !== "level_up" && x.type !== "flower");
              if rewards.length === 0
                p.text-center.p-5 Looks like we're missing devil's tree data.
                  |
                  |
                  a(href=card.uniqueName+"/edit") Add missing data!
              else
                each i in rewards
                  +dtTemplate(i)
            br
            p.section-title Level up
            div.row.justify-content-center
              - let levelNodes = card.dt.filter(x => x.type === "level_up" || x.type === "flower");
              if levelNodes.length === 0
                p.text-center.p-5 Looks like we're missing devil's tree data.
                  |
                  |
                  a(href=card.uniqueName+"/edit") Add missing data!
              else
                each i in levelNodes
                  +dtTemplate(i)
          else
            p.text-center.p-5 Looks like we're missing devil's tree data.
              |
              |
              a(href=card.uniqueName+"/edit") Add missing data!

    if card.rarity === "UR+"
      br
      div(style="border:2px solid #e8eaf6;border-radius:8px;background:rgba(255,255,255,.8);padding:1.5rem;padding-bottom:2rem;")
        div.row
          div.col-12.col-md-10.mx-auto
            h2.text-center Animations
            div.row.justify-content-center.pt-md-3
              if card.animation.type === "homescreen"
                div.col-12.d-flex.flex-wrap
                  div.animation: div
                    if !card.animation || !card.animation.link1
                      div.text-center.py-5
                        p Looks like we are missing an animation.
                        a(href="https://drive.google.com/drive/folders/1dhyuCl3lw8swEwjCuoJ_gkkbeyplFpQn?usp=sharing") Upload animation!
                    else
                      iframe(src="https://player.vimeo.com/video/" + card.animation.link1 + "?autoplay=1&loop=1&autopause=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;" title="Makeup Transformation! (Original)")

                  div.animation: div
                    if !card.animation || !card.animation.link2
                      div.text-center.py-5
                        p Looks like we are missing an animation.
                        a(href="https://drive.google.com/drive/folders/1dhyuCl3lw8swEwjCuoJ_gkkbeyplFpQn?usp=sharing") Upload animation!
                    else
                      iframe(src="https://player.vimeo.com/video/" + card.animation.link2 + "?autoplay=1&loop=1&autopause=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;" title="Makeup Transformation! (Original)")
              else
                if !card.animation || !card.animation.link1
                  div.col-12.text-center.py-5
                    p Looks like we are missing an animation.
                    a(href="https://drive.google.com/drive/folders/1dhyuCl3lw8swEwjCuoJ_gkkbeyplFpQn?usp=sharing") Upload animation!
                else
                  div.col-12.animation: div
                    iframe(src="https://player.vimeo.com/video/" + card.animation.link1 + "?autoplay=1&loop=1&autopause=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;" title="Makeup Transformation! (Original)")

  if user && user.isAdmin
    div(class="modal fade" id="confirmDelete" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteLabel" aria-hidden="true")
      div(class="modal-dialog" role="document")
        div(class="modal-content")
          div(class="modal-body")
            p Are you sure you want to delete this card?
            p#result.alert
          div(class="modal-footer")
            button.btn.btn-danger(onclick="deleteCard()") Delete
            button.btn.btn-secondary(data-dismiss="modal") Cancel
    script.
      function deleteCard() {
        $.post("delete", { card: CARD_NAME }, function(result) {
          if (result.success) {
            $("#result").addClass("alert-success").text("Card deleted. Please refresh page.")
          } else {
            $("#result").addClass("alert-danger").text(JSON.stringify(result));
          }
        });
      }
  -
    function getTotalStrength(val) {
      let total = 0;
      for (const attribute of attributeList) {
        if (!card.strength || !card.strength[attribute] || !card.strength[attribute][val]) {
          return "???";
        } else {
          total += card.strength[attribute][val];
        }
      }
      return total.toLocaleString("en");
    }
