extends layout

block scripts
	link(rel="stylesheet" href="/stylesheets/calculator.css")
	script(src="/javascripts/calculator.js")

	script.
		startCountdown(!{JSON.stringify(event.end)})
		var event = !{JSON.stringify(event)};

mixin resultBlock(type, dict)
	div(class=type+"_calculation")
		p= t("calculator."+type)
		div.p-3
			div
				span= t("calculator.free")
				span= getValue(dict.free)
			div
				span= t("calculator.buy")
				span= getValue(dict.buy)
			hr.my-2(style="border-color:var(--primary);")
			div
				span Total
				span= getValue(dict.total)

block content
	.container
		h1 Pop Quiz Calculator

		//- on-going event
		if (event.start <= new Date() && event.end >= new Date())
			-
				function getValue(i) {
					if (typeof i !== "number") return "???";
					return i.toLocaleString("en");
				}

				function getDaysLeft(d) {
					var today = new Date();
					return Math.floor((d - today) / (1000 * 60 * 60 * 24));
				}

				function getDaysLeftPercentage(start, end) {
					var duration = Math.floor((end - start) / (1000 * 60 * 60 * 24));
					var daysPast = duration - getDaysLeft(end);
					return Math.floor(daysPast / duration * 100);
				}

			.row
				.col-12.col-lg-4.mb-3
					.card.h-100
						div.card-body
							p.text-center.text-primary(style="letter-spacing:.25rem;")
								strong CALCULATOR
							form.mb-3
								h6 Required
								div.form-group
									label(for="pointsPerBattle")= t("calculator.ppt")
									// min=120 for now, need to change based on event type
									input#pointsPerBattle.form-control(type="number" name="pointsPerBattle" min="120" value=query.pointsPerBattle required)
								div.form-group
									label(for="currentPoints")= t("calculator.currentPts")
									input#currentPoints.form-control(type="number" name="currentPoints" min="0" value=query.currentPoints required)
								h6 Optional
								div.form-group
									label(for="customGoal")= t("calculator.goal")
									input#customGoal.form-control(type="number" name="customGoal" min="0" value=query.customGoal)
								div.form-group
									label(for="stagesCleared")= t("calculator.stageClear1")
										input#stagesCleared.form-control.form-control-sm.mx-2(type="number" name="stagesCleared" min="0" max=event.stages value=query.stagesCleared?query.stagesCleared:0 style="display:inline;width:4rem;")
										| #{t("calculator.stageClear2")}
									input.custom-range(type="range" min="0" max=event.stages value=query.stagesCleared?query.stagesCleared:0)
								input.btn.btn-primary.btn-block(type="submit" value=t("calculator.calculate"))
							small.text-muted= t("calculator.disclaimer")

				.col-12.col-lg-8.mb-3
					.card.h-100
						- var lst = (result ? result.map(x => Object.assign(x, event.rewards.find(y => y.tag === x.tag))) : event.rewards).filter(x => x.tag);
						- if (query.customGoal) lst.find(x => x.tag === "Custom").points = parseInt(query.customGoal)
						div.card-body
							p.text-center.text-primary(style="letter-spacing:.25rem;")
								strong REWARDS
							ul#rewards.nav.justify-content-around.py-2.mb-3(style="border-radius:16px;border:2px solid var(--secondary);")
								each reward in lst
									li.nav-item
										a.nav-link(id=reward.tag.replace(" ", "")+"-tab" href=("#"+reward.tag.replace(" ", "")) data-toggle="tab" role="tab" aria-controls=reward.tag.replace(" ", ""))
											div.mx-auto.mb-1.d-flex.align-items-center(style="width:4.5rem;height:4.5rem;")
												if reward.card
													img.img-fluid(src=`/images/cards/S/${reward.card.uniqueName.replace(/ /g, '_')}.jpg`)
												else
													img.img-fluid(src=`/images/${reward.tag}.png` onerror="this.src='/images/reward_placeholder.png';")
											figcaption.text-dark.text-center= reward.points.toLocaleString("en")
							div.tab-content
								each res in lst
									div.tab-pane(id=res.tag.replace(" ", "") role="tabpanel")
										div.row
											.col-lg-5.px-4
												div.force-reward-display-height
													if res.card
														div.text-center
															a.px-3.mb-2.d-none.d-lg-block(href="/card/"+getURL(res.card.name))
																img.img-fluid(src=`/images/cards/L/${res.card.uniqueName}.jpg`)
															a(href="/card/"+getURL(res.card.name))= t("lang") === "ja" ? res.card.ja_name : res.card.name

													else
														h5.text-center
															p.text-primary= t("calculator.goal")
															p= (res.points).toLocaleString("en")
											.col-lg-7
												if res.collected
													div(style="position:absolute;display:flex;justify-content:center;align-items:center;background:rgba(255,255,255,.75);width:100%;height:100%;z-index:1;margin-left:-15px;")
														img(src="/images/completed.png")
												ul#results.nav.mb-3
													li.nav-item
														a.nav-link.active(id=res.tag.replace(" ", "")+"-today-tab" href="#"+res.tag.replace(" ", "")+"-today" data-toggle="tab" role="tab" aria-controls=res.tag.replace(" ", "")+"-today" aria-selected="true")= t("calculator.today")
													li.nav-item
														a.nav-link(id=res.tag.replace(" ", "")+"-summary-tab" href="#"+res.tag.replace(" ", "")+"-summary" data-toggle="tab" role="tab" aria-controls=res.tag.replace(" ", "")+"-summary" aria-selected="false")= t("calculator.summary")
												div.tab-content
													div.tab-pane(id=res.tag.replace(" ", "")+"-today" class="show active" role="tabpanel")
														div.row.mx-0.mb-3
															div.col-6.pl-0.pr-1
																- temp = res.battles?res.battles.today:{};  // hard code...
																+resultBlock("battles", temp)
															div.col-6.pl-1.pr-0
																- temp = res.ap?res.ap.today:{};
																+resultBlock("ap", temp)
														div.text-center
															p.mt-3.mb-0.text-primary= t("calculator.goalToday")
															p(style="font-size:large")= getValue(res.goalToday)
															p.mb-0(style="font-size:large") <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock mr-1" viewBox="0 0 16 16">   <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>   <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/> </svg>
																span.countdown
													div.tab-pane(id=res.tag.replace(" ", "")+"-summary" role="tabpanel")
														div.row.m-0
															div.col-6.pl-0.pr-1
																- temp = res.battles?res.battles.total:{};
																+resultBlock("battles", temp)
															div.col-6.pl-1.pr-0
																- temp = res.ap?res.ap.total:{}
																+resultBlock("ap", temp)
														.progress.mt-3(style="height:9px;")
															.progress-bar(style="width:"+getDaysLeftPercentage(event.start, event.end)+"%;height:9px;background-color:#ffbd8a;" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100")
														.d-flex.justify-content-between
															small= t("calculator.endingIn")
															- var daysLeft = getDaysLeft(event.end);
															small= t("lang") === "en" ? "< " + daysLeft + " day" : daysLeft + "æ—¥" : daysLeft > 1 ? daysLeft + " days"
														.progress.mt-3(style="height:9px;")
															.progress-bar(style="width:"+Math.floor(query.currentPoints/res.points*100)+"%;height:9px;background-color:#9fec3e;" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100")
														.d-flex.justify-content-between
															small= (query.currentPoints ? Math.floor(query.currentPoints/res.points*100) : 0) + "%"
															small #{(res.points).toLocaleString("en")} pts
			div.row.mt-3
				div.col-lg-8.mb-3.mb-lg-0
					div.card.card-body
						h5.text-center Notes
						hr(style="border-color:var(--secondary);border-width:2px;margin-top:0;")
						div.row.px-2
							div.col-lg-6.mb-3.mb-lg-0 !{t("calculator.FreeBattles")}
							div.col-lg-6
								ul
									| !{t("calculator.FreeAP")}
									if event.ap
										li FRee AP
									else
										li NAN

				div.col-lg-4
					div.card.card-body.h-100
						h5.text-primary Coming soon...

		else
			div.card.card-body
				h5.mx-auto.my-5 Coming soon!
